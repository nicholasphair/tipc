name: build

defaults:
  run:
    shell: bash -ieo pipefail {0}

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: 
          - ubuntu-18.04
          - macos-10.15
    steps:
      - uses: actions/checkout@v2
      - run: ./bin/bootstrap.sh
      - run: |
          mkdir build
          pushd build
          cmake ../
          make -j2
          popd
      - name: Cache build
        if: runner.os == 'Linux'
        id: cache-build
        uses: actions/cache@v2
        with:
          path: build
          key: linux-build-${{ github.sha }}
  tests:
    needs: build
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Restore build
        id: cache-build
        uses: actions/cache@v2
        with:
          path: build
          key: linux-build-${{ github.sha }}
      - run: ./bin/runtests.sh
      - run: ./bin/gencov.sh
  docs:
    needs: build
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Restore build
        id: cache-build
        uses: actions/cache@v2
        with:
          path: build
          key: linux-build-${{ github.sha }}
      - run: sudo apt install lcov doxygen graphviz python3 python3-pip
      - run: python3 -m pip install setuptools coverxygen
      - run: ./bin/gendocs.sh

